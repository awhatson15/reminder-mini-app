# Telegram Mini App для напоминаний

Это приложение позволяет пользователям Telegram создавать и управлять напоминаниями через мини-приложение внутри мессенджера.

## Обзор улучшений проекта

В процессе рефакторинга были внесены следующие усовершенствования:

### Архитектурные улучшения
- Введена 3-уровневая архитектура с разделением на репозитории, сервисы и контроллеры
- Добавлены слои абстракции для улучшения поддерживаемости кода
- Оптимизирована структура проекта для легкости навигации

### Повышение производительности
- Добавлены индексы для коллекций MongoDB для ускорения запросов
- Внедрена компрессия HTTP-ответов
- Добавлено кеширование статических файлов
- Оптимизированы запросы к базе данных

### Улучшение безопасности
- Добавлена валидация данных Telegram WebApp
- Внедрены middleware для валидации запросов
- Настроена защита от превышения лимитов запросов
- Добавлены проверки прав доступа к данным

### Улучшение обработки ошибок
- Внедрена централизованная обработка ошибок
- Добавлено логирование с различными уровнями
- Добавлена обработка непредвиденных исключений

### Тестовая инфраструктура
- Добавлены модульные тесты для моделей, сервисов и контроллеров
- Добавлены интеграционные тесты для API
- Создана конфигурация Jest для запуска тестов и проверки покрытия кода
- Добавлены моки для тестирования внешних зависимостей

## Тесты

Проект включает различные уровни тестирования:

### Модульные тесты
- **Модели**: тесты для моделей Mongoose (User, Reminder)
- **Сервисы**: тесты сервисного слоя с моками репозиториев
- **Контроллеры**: тесты обработчиков API с моками сервисов
- **Middleware**: тесты для промежуточного ПО (обработка ошибок, валидация)

### Интеграционные тесты
- Тесты API с использованием Supertest
- Проверка взаимодействия всех компонентов

## Запуск тестов

Для запуска тестов используйте команду:

```bash
npm test
```

Для просмотра покрытия кода тестами:

```bash
npm run test:coverage
```

## Установка и запуск

### Установка

Для Windows:
```
install.bat
```

Для Linux/Mac:
```
chmod +x install.sh
./install.sh
```

### Запуск в режиме разработки

```
npm run dev
```

### Запуск в режиме production

```
npm start
```

## Переменные окружения

Проект использует следующие переменные окружения, которые можно настроить в файле `.env`:

- **PORT**: порт для запуска сервера
- **NODE_ENV**: окружение (development, production, test)
- **MONGO_URI**: строка подключения к MongoDB
- **BOT_TOKEN**: токен Telegram бота
- **WEBHOOK_URL**: URL для вебхука бота
- **LOG_LEVEL**: уровень логирования
- **ALLOWED_ORIGINS**: разрешенные источники для CORS
- **DEFAULT_PAGE_LIMIT**: лимит пагинации по умолчанию

## Особенности приложения

- Добавление напоминаний о днях рождения (год не обязателен) и других событиях
- Интерактивный интерфейс с выпадающими меню и календарями для выбора дат
- Автоматическая отправка напоминаний за заданное количество дней до события
- Сортировка напоминаний по дате или имени
- Детальная система логирования и мониторинга
- Многопользовательский режим
- Хранение данных в MongoDB

## Технологический стек

- **Frontend**: React.js, Material UI, Telegram Web App API
- **Backend**: Node.js, Express
- **База данных**: MongoDB
- **Контейнеризация**: Docker, Docker Compose
- **Мониторинг и логирование**: Winston

## Структура проекта

```
reminder-mini-app/
├── app/                         # React-приложение (Frontend)
│   ├── public/                  # Статические файлы
│   └── src/                     # Исходный код
│       ├── components/          # React компоненты
│       └── App.js               # Основной компонент приложения
├── server/                      # Backend API
│   ├── models/                  # Mongoose модели
│   ├── routes/                  # API маршруты
│   ├── utils/                   # Утилиты
│   ├── jobs/                    # Фоновые задачи и напоминания
│   └── index.js                 # Точка входа сервера
├── logs/                        # Директория для логов
├── .env                         # Переменные окружения
├── Dockerfile                   # Docker-конфигурация
├── docker-compose.yml           # Docker Compose конфигурация
└── package.json                 # Зависимости проекта
```

## Подготовка к развертыванию

1. Создайте бот в Telegram через [@BotFather](https://t.me/botfather) и получите token
2. Включите возможность использования Mini Apps в настройках бота
3. Настройте домен для своего приложения
4. Создайте файл `.env` на основе примера из репозитория

## Установка и запуск с помощью Docker Compose

### Предварительные требования

- Docker
- Docker Compose
- Зарегистрированный Telegram Bot

### Шаги по развертыванию

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/yourusername/reminder-mini-app.git
   cd reminder-mini-app
   ```

2. Создайте файл `.env` в корневой директории проекта:
   ```
   BOT_TOKEN=your_telegram_bot_token
   WEBHOOK_URL=https://your-domain.com
   ```

3. Запустите приложение с помощью Docker Compose:
   ```bash
   docker-compose up -d
   ```

4. Приложение будет доступно по адресу `http://localhost:3000`, но для корректной работы с Telegram необходимо настроить HTTPS и домен.

### Настройка для работы с Telegram

1. Настройте веб-сервер (например, Nginx) для проксирования запросов на ваше приложение и обеспечения HTTPS
2. Укажите в BotFather URL вашего приложения для Mini App (https://your-domain.com)

## Мониторинг и логирование

Система логирования настроена с использованием Winston:

- Все логи сохраняются в директории `/app/logs`
- Доступны следующие логи:
  - `combined.log` - все сообщения
  - `error.log` - только ошибки
  - `exceptions.log` - необработанные исключения
  - `rejections.log` - необработанные отклонения Promise

## Работа с системой

### Управление напоминаниями через API

Основные эндпоинты API:

- `GET /api/reminders?telegramId=123456789` - получить все напоминания пользователя
- `POST /api/reminders` - создать новое напоминание
- `GET /api/reminders/:id` - получить напоминание по ID
- `PUT /api/reminders/:id` - обновить напоминание
- `DELETE /api/reminders/:id` - удалить напоминание

### Структура запроса для создания напоминания

```json
{
  "telegramId": 123456789,
  "title": "День рождения Ивана",
  "type": "birthday",
  "date": {
    "day": 15,
    "month": 6,
    "year": 1990  // Год не обязателен для дней рождения
  },
  "description": "Купить подарок",
  "notifyDaysBefore": 3
}
```

## Разработка

Для локальной разработки:

1. Установите зависимости сервера:
   ```bash
   npm install
   ```

2. Установите зависимости клиента:
   ```bash
   cd app && npm install
   ```

3. Запустите сервер в режиме разработки:
   ```bash
   npm run dev
   ```

4. Запустите клиент в режиме разработки:
   ```bash
   cd app && npm start
   ```

## Масштабирование

Приложение легко масштабируется благодаря:

- Контейнеризации с Docker
- Возможности запуска нескольких экземпляров за балансировщиком нагрузки
- Использованию MongoDB, которая поддерживает шардинг и репликацию
- Модульной структуре кода

## Обслуживание

Для обновления приложения:

1. Остановите контейнеры:
   ```bash
   docker-compose down
   ```

2. Соберите новый образ и запустите контейнеры:
   ```bash
   docker-compose up -d --build
   ```

## Лицензия

MIT 

