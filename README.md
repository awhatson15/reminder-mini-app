# Telegram Mini App для напоминаний

Это приложение позволяет пользователям Telegram создавать и управлять напоминаниями через мини-приложение внутри мессенджера.

## Обзор улучшений проекта

В процессе рефакторинга были внесены следующие усовершенствования:

### Архитектурные улучшения
- Введена 3-уровневая архитектура с разделением на репозитории, сервисы и контроллеры
- Добавлены слои абстракции для улучшения поддерживаемости кода
- Оптимизирована структура проекта для легкости навигации

### Повышение производительности
- Добавлены индексы для коллекций MongoDB для ускорения запросов
- Внедрена компрессия HTTP-ответов
- Добавлено кеширование статических файлов
- Оптимизированы запросы к базе данных

### Улучшение безопасности
- Добавлена валидация данных Telegram WebApp
- Внедрены middleware для валидации запросов
- Настроена защита от превышения лимитов запросов
- Добавлены проверки прав доступа к данным

### Улучшение обработки ошибок
- Внедрена централизованная обработка ошибок
- Добавлено логирование с различными уровнями
- Добавлена обработка непредвиденных исключений

### DevOps улучшения
- Настроен CI/CD пайплайн с использованием GitHub Actions
- Добавлен автоматизированный мониторинг с Prometheus и Grafana
- Настроены автоматические оповещения через Telegram
- Улучшена конфигурация Docker с добавлением healthcheck
- Добавлены ресурсные ограничения для контейнеров
- Настроен реверс-прокси Traefik с автоматическим получением SSL сертификатов
- Добавлена поддержка масштабирования для production окружения

### Тестовая инфраструктура
- Добавлены модульные тесты для моделей, сервисов и контроллеров
- Добавлены интеграционные тесты для API
- Создана конфигурация Jest для запуска тестов и проверки покрытия кода
- Добавлены моки для тестирования внешних зависимостей

## Тесты

Проект включает различные уровни тестирования:

### Модульные тесты
- **Модели**: тесты для моделей Mongoose (User, Reminder)
- **Сервисы**: тесты сервисного слоя с моками репозиториев
- **Контроллеры**: тесты обработчиков API с моками сервисов
- **Middleware**: тесты для промежуточного ПО (обработка ошибок, валидация)

### Интеграционные тесты
- Тесты API с использованием Supertest
- Проверка взаимодействия всех компонентов

## Запуск тестов

Для запуска тестов используйте команду:

```bash
npm test
```

Для просмотра покрытия кода тестами:

```bash
npm run test:coverage
```

## Установка и запуск

### Установка

Для Windows:
```
install.bat
```

Для Linux/Mac:
```
chmod +x install.sh
./install.sh
```

### Запуск в режиме разработки

```
npm run dev
```

### Запуск в режиме production

```
npm start
```

## Переменные окружения

Проект использует следующие переменные окружения, которые можно настроить в файле `.env`:

- **PORT**: порт для запуска сервера
- **NODE_ENV**: окружение (development, production, test)
- **MONGO_URI**: строка подключения к MongoDB
- **BOT_TOKEN**: токен Telegram бота
- **WEBHOOK_URL**: URL для вебхука бота
- **LOG_LEVEL**: уровень логирования
- **ALLOWED_ORIGINS**: разрешенные источники для CORS
- **DEFAULT_PAGE_LIMIT**: лимит пагинации по умолчанию

## Особенности приложения

- Добавление напоминаний о днях рождения (год не обязателен) и других событиях
- Интерактивный интерфейс с выпадающими меню и календарями для выбора дат
- Автоматическая отправка напоминаний за заданное количество дней до события
- Сортировка напоминаний по дате или имени
- Детальная система логирования и мониторинга
- Многопользовательский режим
- Хранение данных в MongoDB

## Технологический стек

- **Frontend**: React.js, Material UI, Telegram Web App API
- **Backend**: Node.js, Express
- **База данных**: MongoDB
- **Контейнеризация**: Docker, Docker Compose
- **CI/CD**: GitHub Actions
- **Мониторинг**: Prometheus, Grafana
- **Логирование**: Winston
- **Реверс-прокси**: Traefik
- **Оповещения**: Alertmanager с интеграцией Telegram

## Структура проекта

```
reminder-mini-app/
├── app/                         # React-приложение (Frontend)
│   ├── public/                  # Статические файлы
│   └── src/                     # Исходный код
│       ├── components/          # React компоненты
│       └── App.js               # Основной компонент приложения
├── server/                      # Backend API
│   ├── models/                  # Mongoose модели
│   ├── routes/                  # API маршруты
│   ├── utils/                   # Утилиты
│   ├── jobs/                    # Фоновые задачи и напоминания
│   └── index.js                 # Точка входа сервера
├── prometheus/                  # Конфигурация Prometheus
├── alertmanager/                # Конфигурация Alertmanager
├── traefik/                     # Конфигурация Traefik
├── .github/                     # GitHub Actions workflows
├── logs/                        # Директория для логов
├── .env                         # Переменные окружения
├── docker-compose.yml           # Docker Compose для разработки
├── docker-compose.prod.yml      # Docker Compose для production
└── package.json                 # Зависимости проекта
```

## CI/CD пайплайн

Проект настроен с автоматическим CI/CD пайплайном:

1. **Тестирование**: при каждом push и PR запускаются линтинг и тесты
2. **Сборка**: при успешных тестах собирается Docker образ
3. **Развертывание**: автоматическое обновление на production сервере

## Мониторинг и оповещения

Система мониторинга включает:

- **Prometheus**: сбор метрик приложения, сервера и контейнеров
- **Grafana**: визуализация метрик и создание дашбордов
- **Alertmanager**: настройка правил оповещений
- **Telegram Bot**: отправка уведомлений об инцидентах
- **Node Exporter**: мониторинг сервера
- **cAdvisor**: мониторинг контейнеров

## Подготовка к развертыванию

1. Создайте бот в Telegram через [@BotFather](https://t.me/botfather) и получите token
2. Включите возможность использования Mini Apps в настройках бота
3. Настройте домен для своего приложения
4. Создайте файл `.env` на основе примера из репозитория

## Установка и запуск с помощью Docker Compose

### Предварительные требования

- Docker
- Docker Compose
- Зарегистрированный Telegram Bot

### Шаги по развертыванию в режиме разработки

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/yourusername/reminder-mini-app.git
   cd reminder-mini-app
   ```

2. Создайте файл `.env` в корневой директории проекта:
   ```
   BOT_TOKEN=your_telegram_bot_token
   WEBHOOK_URL=https://your-domain.com
   ```

3. Запустите приложение с помощью Docker Compose:
   ```bash
   docker-compose up -d
   ```

### Шаги по развертыванию в production

1. Создайте файл `.env.prod` на основе `.env.prod.example`:
   ```bash
   cp .env.prod.example .env.prod
   nano .env.prod # Отредактируйте переменные окружения
   ```

2. Запустите приложение в production-режиме:
   ```bash
   docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d
   ```

3. Проверьте мониторинг по адресу:
   ```
   https://your-domain.com/grafana
   ```

### Автоматическое развертывание

Для настройки автоматического развертывания:

1. В репозитории GitHub настройте следующие секреты:
   - `DOCKER_HUB_USERNAME`: имя пользователя Docker Hub
   - `DOCKER_HUB_TOKEN`: токен доступа Docker Hub
   - `DEPLOY_HOST`: IP или доменное имя сервера
   - `DEPLOY_USER`: пользователь для SSH доступа
   - `DEPLOY_SSH_KEY`: приватный SSH ключ
   - `DEPLOY_PATH`: путь к директории проекта на сервере

2. При push в ветку main/master будет автоматически запущен CI/CD пайплайн.

## Мониторинг и логирование

Система логирования настроена с использованием Winston:

- Все логи сохраняются в директории `/app/logs`
- Доступны следующие логи:
  - `combined.log` - все сообщения
  - `error.log` - только ошибки
  - `exceptions.log` - необработанные исключения
  - `rejections.log` - необработанные отклонения Promise

## Работа с системой

### Управление напоминаниями через API

Основные эндпоинты API:

- `GET /api/reminders?telegramId=123456789` - получить все напоминания пользователя
- `POST /api/reminders` - создать новое напоминание
- `GET /api/reminders/:id` - получить напоминание по ID
- `PUT /api/reminders/:id` - обновить напоминание
- `DELETE /api/reminders/:id` - удалить напоминание

### Структура запроса для создания напоминания

```json
{
  "telegramId": 123456789,
  "title": "День рождения Ивана",
  "type": "birthday",
  "date": {
    "day": 15,
    "month": 6,
    "year": 1990  // Год не обязателен для дней рождения
  },
  "description": "Купить подарок",
  "notifyDaysBefore": 3
}
```

## Масштабирование

Приложение легко масштабируется благодаря:

- Контейнеризации с Docker
- Возможности запуска нескольких экземпляров за балансировщиком нагрузки
- Использованию MongoDB, которая поддерживает шардинг и репликацию
- Модульной структуре кода
- Поддержке горизонтального масштабирования через Docker Swarm или Kubernetes

## Обслуживание и обновление

Для обновления приложения:

1. Автоматическое обновление через CI/CD:
   - Просто создайте PR и слейте его в main ветку

2. Ручное обновление:
   ```bash
   # Развертывание в режиме разработки
   docker-compose down
   git pull
   docker-compose up -d --build
   
   # Развертывание в production
   docker-compose -f docker-compose.prod.yml --env-file .env.prod down
   git pull
   docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d --build
   ```

## Лицензия

MIT 

